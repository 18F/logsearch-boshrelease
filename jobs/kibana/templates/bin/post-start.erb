#!/bin/bash

set -e

<% if !p("kibana.health.disable_post_start") %>

echo "Waiting <%= p("kibana.health.timeout") %>s for kibana to accept connections..."
elapsed=0
until [ $elapsed -ge <%= p("kibana.health.timeout") %> ]
do
  curl -is http://<%= p("kibana.host") %>:<%= p("kibana.port") %> 2>&1 && break
  elapsed=$[$elapsed+<%= p("kibana.health.interval") %>]
  sleep <%= p("kibana.health.interval") %>
done

if [ "$elapsed" -ge "<%= p("kibana.health.timeout") %>" ]; then
  echo "ERROR: Cannot connect to kibana. Exiting..."
  exit 1
fi

# convert index if it is an old version
# Note:  You can also just nuke .kibana with `curl -k -X DELETE http://localhost:9200/.kibana` while logged into the kibana instance and
#        then recreate everything with `bosh run-errand -d logsearch upload-kibana-objects`.  Though this will delete dashboards that others
#        have made, so be careful.  Consider doing a backup by exporting all objects first.

if curl -s http://127.0.0.1:5602/api/status | grep 'Your Kibana index is out of date, reset it or use the X-Pack upgrade assistant' >/dev/null ; then
  echo "converting .kibana index to new 6.x format"

  # do the migration as per https://www.elastic.co/guide/en/kibana/6.0/migrating-6.0-index.html#migrating-6.0-index
  curl -X PUT "localhost:9200/.kibana/_settings" -H 'Content-Type: application/json' -d'{"index.blocks.write": true}'
  curl -X PUT "localhost:9200/.kibana-6" -H 'Content-Type: application/json' -d'
    {
      "settings" : {
        "number_of_shards" : 1,
        "index.mapper.dynamic": false
      },
      "mappings" : {
        "doc": {
          "properties": {
            "type": {
              "type": "keyword"
            },
            "updated_at": {
              "type": "date"
            },
            "config": {
              "properties": {
                "buildNum": {
                  "type": "keyword"
                }
              }
            },
            "index-pattern": {
              "properties": {
                "fieldFormatMap": {
                  "type": "text"
                },
                "fields": {
                  "type": "text"
                },
                "intervalName": {
                  "type": "keyword"
                },
                "notExpandable": {
                  "type": "boolean"
                },
                "sourceFilters": {
                  "type": "text"
                },
                "timeFieldName": {
                  "type": "keyword"
                },
                "title": {
                  "type": "text"
                }
              }
            },
            "visualization": {
              "properties": {
                "description": {
                  "type": "text"
                },
                "kibanaSavedObjectMeta": {
                  "properties": {
                    "searchSourceJSON": {
                      "type": "text"
                    }
                  }
                },
                "savedSearchId": {
                  "type": "keyword"
                },
                "title": {
                  "type": "text"
                },
                "uiStateJSON": {
                  "type": "text"
                },
                "version": {
                  "type": "integer"
                },
                "visState": {
                  "type": "text"
                }
              }
            },
            "search": {
              "properties": {
                "columns": {
                  "type": "keyword"
                },
                "description": {
                  "type": "text"
                },
                "hits": {
                  "type": "integer"
                },
                "kibanaSavedObjectMeta": {
                  "properties": {
                    "searchSourceJSON": {
                      "type": "text"
                    }
                  }
                },
                "sort": {
                  "type": "keyword"
                },
                "title": {
                  "type": "text"
                },
                "version": {
                  "type": "integer"
                }
              }
            },
            "dashboard": {
              "properties": {
                "description": {
                  "type": "text"
                },
                "hits": {
                  "type": "integer"
                },
                "kibanaSavedObjectMeta": {
                  "properties": {
                    "searchSourceJSON": {
                      "type": "text"
                    }
                  }
                },
                "optionsJSON": {
                  "type": "text"
                },
                "panelsJSON": {
                  "type": "text"
                },
                "refreshInterval": {
                  "properties": {
                    "display": {
                      "type": "keyword"
                    },
                    "pause": {
                      "type": "boolean"
                    },
                    "section": {
                      "type": "integer"
                    },
                    "value": {
                      "type": "integer"
                    }
                  }
                },
                "timeFrom": {
                  "type": "keyword"
                },
                "timeRestore": {
                  "type": "boolean"
                },
                "timeTo": {
                  "type": "keyword"
                },
                "title": {
                  "type": "text"
                },
                "uiStateJSON": {
                  "type": "text"
                },
                "version": {
                  "type": "integer"
                }
              }
            },
            "url": {
              "properties": {
                "accessCount": {
                  "type": "long"
                },
                "accessDate": {
                  "type": "date"
                },
                "createDate": {
                  "type": "date"
                },
                "url": {
                  "type": "text",
                  "fields": {
                    "keyword": {
                      "type": "keyword",
                      "ignore_above": 2048
                    }
                  }
                }
              }
            },
            "server": {
              "properties": {
                "uuid": {
                  "type": "keyword"
                }
              }
            },
            "timelion-sheet": {
              "properties": {
                "description": {
                  "type": "text"
                },
                "hits": {
                  "type": "integer"
                },
                "kibanaSavedObjectMeta": {
                  "properties": {
                    "searchSourceJSON": {
                      "type": "text"
                    }
                  }
                },
                "timelion_chart_height": {
                  "type": "integer"
                },
                "timelion_columns": {
                  "type": "integer"
                },
                "timelion_interval": {
                  "type": "keyword"
                },
                "timelion_other_interval": {
                  "type": "keyword"
                },
                "timelion_rows": {
                  "type": "integer"
                },
                "timelion_sheet": {
                  "type": "text"
                },
                "title": {
                  "type": "text"
                },
                "version": {
                  "type": "integer"
                }
              }
            },
            "graph-workspace": {
              "properties": {
                "description": {
                  "type": "text"
                },
                "kibanaSavedObjectMeta": {
                  "properties": {
                    "searchSourceJSON": {
                      "type": "text"
                    }
                  }
                },
                "numLinks": {
                  "type": "integer"
                },
                "numVertices": {
                  "type": "integer"
                },
                "title": {
                  "type": "text"
                },
                "version": {
                  "type": "integer"
                },
                "wsState": {
                  "type": "text"
                }
              }
            }
          }
        }
      }
    }
  '
  curl -X POST "localhost:9200/_reindex" -H 'Content-Type: application/json' -d'
    {
      "source": {
        "index": ".kibana"
      },
      "dest": {
        "index": ".kibana-6"
      },
      "script": {
        "inline": "ctx._source = [ ctx._type : ctx._source ]; ctx._source.type = ctx._type; ctx._id = ctx._type + \":\" + ctx._id; ctx._type = \"doc\"; ",
        "lang": "painless"
      }
    }
  '
  curl -X POST "localhost:9200/_aliases" -H 'Content-Type: application/json' -d'
    {
      "actions" : [
        { "add":  { "index": ".kibana-6", "alias": ".kibana" } },
        { "remove_index": { "index": ".kibana" } }
      ]
    }
  '
fi

<% end %>

exit 0
