input {
	lumberjack {
		add_field => [ "_logstash_input", "lumberjack" ]
		host => "0.0.0.0"
		port => "<%= p("ingestor.lumberjack.endpoint.port") %>"
		ssl_certificate => "/var/vcap/jobs/ingestor_lumberjack/config/lumberjack.crt"
		ssl_key => "/var/vcap/jobs/ingestor_lumberjack/config/lumberjack.key"
	}
}

filter {
	if [_logstash_input] == "lumberjack" {
		mutate {
			add_field => [ "@source.host", "%{host}" ]
			add_field => [ "@source.path", "%{file}" ]
			add_field => [ "@source.offset", "%{offset}" ]
			remove_field => [ "host", "file", "offset", "_logstash_input" ]
		}
	}
}
				
output {
	<% if_p("ingestor.lumberjack.debug") do %>
	stdout { debug => true codec => "json"}
	<% end %>

	redis {
		host => "<%= p("queue.endpoint.host") %>:<%= p("queue.endpoint.port") %>"
		data_type => "list"
		key => "<%= p("queue.name") %>"
		batch => true
		batch_events => 50
	}
}
