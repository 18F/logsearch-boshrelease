#!/bin/bash

# this script will re-enable shard allocations if the drain script was used
# and caused allocations to be disabled

<% if !p('elasticsearch.drain') %>
# elasticsearch.drain is disabled in the manifest
exit 0
<% elsif !p('elasticsearch.node.allow_data') %>
# this node does not contain data, so we can skip all these data-related tasks
exit 0
<% end %>

# this will be spawned before elasticsearch is ready, so we need to wait until
# we can talk to it
while ! nc -zw 8 localhost 9200 2>&1 > /dev/null ; do sleep 5 ; done

# we should wait until our .bosh index is certainly available for reading
READY=false
while [ "false" == "$READY" ] ; do
    STATUS=`wget -qO- --timeout 16 'localhost:9200/_cat/health?h=status'`

    if [ "green" != "$STATUS" ] && [ "yellow" != "$STATUS" ] ; then
        READY=true
    else
        sleep 5
    fi
done

if [ '{"drained":1}' == `wget -qO- 'localhost:9200/.bosh/drain/<%= name %>--<%= index %>/_source'` ]; then
    # put allocations back to normal
    curl -sX PUT -d '{"transient":{"cluster.routing.allocation.enable":"all"}}' 'localhost:9200/_cluster/settings' > /dev/null

    # and avoid us doing this next time
    curl -sX DELETE 'localhost:9200/.bosh/drain/<%= name %>--<%= index %>' > /dev/null
fi
