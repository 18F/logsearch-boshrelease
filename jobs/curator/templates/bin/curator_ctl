#!/bin/bash

set -e
set -u
set -x

CRON_SCHEDULE="*/2 * * * * /var/vcap/jobs/curator/bin/run"
CRON_STATUS=`pgrep cron | wc -l`

source /var/vcap/jobs/curator/helpers/ctl_setup.sh 'curator'

case $1 in
  start)
    if [ $CRON_STATUS -eq 0 ]; then
      /usr/sbin/cron start
    fi

    if [ -n "$(crontab -l)" ]; then
      crontab -l > /tmp/crontab_buffer
    fi

    if [ -z "$(crontab -l | grep 'run')" ] ; then
      echo "$CRON_SCHEDULE" >> /tmp/crontab_buffer
    fi

    crontab < /tmp/crontab_buffer

    rm -f /tmp/crontab_buffer
    pgrep cron > /var/vcap/sys/run/curator/curator.pid
    ;;
  stop)

    if [ -z "$(crontab -l | grep -v 'run')" ]; then
      crontab -r
    else
      crontab -l > /tmp/crontab_buffer
      cat /tmp/crontab_buffer | grep -v "run" > /tmp/crontab_buffer
      crontab < /tmp/crontab_buffer
    fi


    rm -f /tmp/crontab_buffer
    rm -f /var/vcap/sys/run/curator/curator.pid

    ;;
  *)
    echo "Usage: curator_ctl {start|stop}"
    ;;

esac
